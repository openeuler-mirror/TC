---
标题:    openEuler多版本内核支持
类别:    特性变更
摘要:    openEuler LTS支持多个版本的内核
作者:    刘恺（kai.liu at xfusion.com）
状态:    初始化
编号:    oEEP-0011
创建日期: 2023-08-09
修订日期: 2023-08-15
---

## 动机与目标

当前openEuler的内核版本与发行版版本按`1:1`绑定，即版本发布时固定了内核版本。这个发布模式带来了一些问题。

1. LTS版本发布时机难以满足多方面的诉求。当前每个LTS版本发布时机需要综合考虑诸多因素，如LTS版本本身的发布时间规划、目标版本上游内核的发布时间、关键新硬件支持代码的上游化进展、社区伙伴和OSV的产品规划等等。这造成了LTS版本选择内核版本时经常陷入两难境地。

2. LTS版本由于生命周期长，导致在生命周期后期阶段时内核已经处于相对较旧的状态，不利于支持新硬件平台和创新特性。虽然可以backport新版本内核特性，但随着版本差距越来越大，移植也越来越困难。

3. 对于用户而言，在某些场景下希望能使用旧的LTS版本以兼容其应用，但希望使用新的内核版本以支持新硬件。

如果将内核版本与LTS发行版版本（即用户态）解绑，改为`N:1`的模式，则该问题可以得到较好解决。业界已有其它发行版支持多个内核版本，以下予以简介以供参考。

### Ubuntu

Ubuntu提供了[Hardware Enablement Stack](https://wiki.ubuntu.com/Kernel/LTSEnablementStack)，又叫LTS Enablement Stack，是在LTS版本上提供的新版本内核和X、mesa等包以支持新的硬件平台。其规则为：每个LTS版本发布后，会收到之后4个Ubuntu版本的内核包作为其HWE内核。以Ubuntu 20.04 LTS版本为例，其发布时的内核为5.4，之后会收到来自20.10（5.8），21.04（5.11），21.10（5.13）和22.04 LTS（5.14）的内核包更新。类似的，Ubuntu 22.04 LTS发布时内核为5.15，在22.04.02 update版本中HWE内核升级到了来自22.10的5.19版本。并且Ubuntu在发布LTS版本的小幅更新版本的安装ISO时，会默认使用HWE内核，使得用户可以在新硬件上获得更好的安装体验。

### Anolis OS 23

在此版本中，龙蜥明确将“双内核”[作为亮点列出](https://gitee.com/anolis/rnotes/blob/master/anolis/rnotes/anolis-23.0-ga.md#311-%E4%BA%AE%E7%82%B9)：“Anolis OS 23 现支持 5.10/6.1 两种内核安装，5.10 为默认内核，内核 6.1 系列为 tech-preview 版本，支持滚动升级”。

### RHEL 7 / CentOS 7

做为反例，Red Hat官方并没有提供新版本内核机制。由于RHEL 7 / CentOS 7的3.10内核太老，虽然红帽官方持续不断的移植新的特性，但新硬件以及容器支持能力依然受到限制。故CentOS 7用户经常会安装ELRepo社区所提供的[kernel-ml](http://elrepo.org/tiki/kernel-ml)或[kernel-lt](http://elrepo.org/tiki/kernel-lt)包，直接使用上游主线或Long Term Support内核。

### openSUSE / SLES

SUSE采用了稍微不同的方案。SUSE虽然不允许同时安装多个大版本的内核，但SUSE每隔一个Service Pack都会升级内核大版本，以提供新硬件和新特性支持。例如：SLES 15 GA内核为4.12，15 SP1延续此版本；SP2则升级到5.3，SP3延续此版本；SP4升级到5.14，SP5延续此版本。该方案可以说是在Red Hat的“只有一个内核大版本，通过不断backport来获取新特性”和Ubuntu的“通过持续发布新内核来获取新特性”之间取得的一个折衷。但该方案带来的一个显著问题是没有为用户提供升级SP但保留旧版本内核继续使用的选项，每两年（两个SP）由于内核大版本升级造成树外模块的不兼容，对用户的升级决策有明显影响。

本提案建议在openEuler LTS版本中参考Ubuntu的模式，支持多个内核版本，以解决当前的问题。

## 对 openEuler 的益处和风险影响

### 益处
- 多版本内核使得openEuler LTS版本在决策内核版本时更容易。
- 多版本内核使得openEuler LTS版本在发布后还可以持续通过新内核获得更好的新硬件和新特性支持，同时保持对上层应用的兼容性。

### 风险
- 内核版本增加后，内核的开发和维护工作量会增加。

为降低该风险，本提案通过将“新openEuler LTS版本的内核”下放到“旧的openEuler LTS版本使用”的方式，不增加需要开发和维护的内核版本，仅增加内核支持的用户态版本，增加的工作量主要是构建、打包和测试。

## 方案描述

设openEuler LTS版本为V1、V2...Vn，内核版本为K1、K2...Kn。

### 发布和维护策略
- V1发布时，原生内核为K1。
- V2发布时，原生内核为K2。
- V2发布时，为V1增加K2内核。
- 在V1和V2上的K2的代码保持统一，仅在构建、打包和测试上有少量差异。
- V3发布时，原生内核为K3。
- V3发布时，为V1和V2增加K3内核。此时V1支持K1、K2、K3内核，V2支持K2、K3内核。
- 由于V1->V2->V3的间隔约为2年，若V1共可获得2次内核更新（K2和K3），则V1到第四年仍然可以获得最新的硬件和内核特性支持，到第6年仍然有不错的硬件兼容性。
- 如有需要，可以对V1提供K4甚至更新的内核。

对于每个LTS版本上引入的非原生新版本内核，称之为“LTS升级内核”，或“LTS Upgrade Kernel”。

### 支持策略
以下几个方案供决策讨论。

#### 固定策略1：每个Kn固定支持Y年，Kn EOS后用户需升级到Kn+1或更新版本。

- 例：K2支持3年，到期后使用K2的V1和V2用户都需要升级到K3。
- 核心逻辑：发行版和内核支持周期完全解耦，可以分别演进。
- 优点：内核支持时间比其它方案短，支持负担低，可以快速演进。
- 缺点：用户需要跟随升级内核。

#### 固定策略2：在Vn上，每个内核都支持到该Vn的生命周期结束。

- 例：在V1上，K1、K2、K3...都支持到V1生命周期结束。
- 核心逻辑：确保Vn上每个Kn都在整个Vn生命周期可用。
- 优点：对用户友好，任意选择一个合适的内核都可以使用到LTS版本生命周期结束。
- 缺点：每个版本的内核的支持时间都很长，支持负担高。

#### 混合策略1：Vn的原生Kn随Vn生命周期完整支持，但Kn+1、+2等后继版本仅支持固定Y年。

- 例：在V1上，K1支持到V1生命周期结束，K2支持3年，到期后需升级到K3。
- 核心逻辑：保证原生内核一直可用，为用户提供兜底选择。新内核主要提供新硬件支持。
- 优点：使用原生内核足够的用户可以一直使用原生内核，不用一直跟随升级内核。
- 缺点：需要新硬件支持并更新了新内核的用户，无法一直使用固定的内核版本，需要跟随升级内核。

## 范围/相关人员及职责

### Kernel SIG
- Kernel代码仓必要的调整
- Kernel spec文件的增强
- 后继版本的持续维护和支持

### OS-Builder SIG
- Anaconda修改
- oemaker修改

### QA SIG
- 定义多内核的测试策略
- 内核测试流程适配
- 安装场景测试流程适配

### Compatibility SIG
- 定义多内核支持后的兼容性策略，包括社区的兼容性测试策略和OSV认证中的兼容性一致性策略，避免对OSV版本的兼容性认证产生冲击。例如：对kernel-desktop包，不强制要求OSV认证必须兼容。
- 兼容性测试流程适配

### Infra SIG
- OBS/EBS构建环境适配
- 镜像发布物适配

### Doc SIG
- 发布说明和文档更新

## 范围/相关软件
至少以下软件包/仓受到影响需修改：

- kernel
- anaconda
- oemaker

## 用户体验
多版本内核支持能大幅提升用户的使用体验。 多版本内核支持可以使得用户在保持北向兼容性的同时，能使用新的硬件平台。

## 发布说明
发布说明需要更新，对该方案进行详细说明。

## 升级与兼容性影响
由于Linux内核对用户态的API和ABI[已经稳定](https://www.kernel.org/doc/Documentation/process/stable-api-nonsense.rst)且会[保持稳定](https://en.wikipedia.org/wiki/Linux_kernel_interfaces)，故多种内核的引入只会影响南向兼容性。

多版本内核支持会为LTS版本引入硬件兼容性变化，需要更新兼容性测试策略和流程，定义：

- 当Kn内核在某个LTS版本上发布后，是需要重新测试该LTS版本的硬件兼容性，还是直接继承Vn的兼容性信息？
- 兼容性信息中需增加测试时使用的内核版本。
- 在兼容性网站上，在查询输入处和结果显示页面，是否需要把发行版和内核版本信息区分单列？
- OSV兼容性评测是否“强制要求”需评测新版本内核，还是作为“可选要求”？

## 如何测试
TBD

## 实施计划
计划在24.0x创新版本实施验证，并进入24.03 LTS SP1版本。